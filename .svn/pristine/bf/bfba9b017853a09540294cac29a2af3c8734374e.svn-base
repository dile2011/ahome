//
//  AFamilyHomeCircleController.m
//  ahome
//
//  Created by dilei liu on 15/6/20.
//  Copyright (c) 2015年 ushome. All rights reserved.
//

#import "AFamilyHomeCircleController.h"
#import "AFamilyCollectionView.h"
#import "AHomeServer.h"
#import "AFamily.h"
#import "AHome.h"
#import "AFamilyHomesController.h"
#import "AMainRootController.h"
#import "AFamilyLevelController.h"
#import "MZBookShelfCollectionViewLayout.h"

@implementation AFamilyHomeCircleController

- (instancetype)init {
    self = [super init];
    _familys = [NSMutableArray array];
    
    return self;
}

- (void)viewDidLoad {
    [super viewDidLoad];
    CGRect frame = CGRectMake((self.view.frame.size.width-40)/2., (self.view.bounds.size.height-130)/2., 40., 40.);
    [[AUtilities sharedInstance]popTarget:self.view frame:frame];
    
    [[AClocker sharedInstance]startjs:^(BOOL finish) {
        [[AUtilities sharedInstance]dismiss];
        AFamily *family =[[AFamily alloc]init];
        [family setFamilyCategory:@"父母圈"];
        [family setServerId:1];
        
        NSMutableArray *homes = [NSMutableArray array];
        AHome *home = [[AHome alloc]init];
        [home setPhoto:@"http://119.29.55.106/Uploads/0/201507/20/55abe8b01df3d.jpg"];
        [home setFamilyId:1];
        [home setMembers:nil];
        [homes addObject:home];
        [family setHomes:homes];
        
        home = [[AHome alloc]init];
        [home setPhoto:@"http://119.29.55.106/Uploads/0/201506/30/5591f7544bfaf.jpg"];
        [home setFamilyId:2];
        [home setMembers:nil];
        [homes addObject:home];
        [family setHomes:homes];
        
        [_familys addObject:family];
        [self relodaAlldata];
    } timeOut:2.];
}

- (NSInteger)numberOfSectionsInCollectionView:(UICollectionView *)collectionView{
    return _familys.count > 0 ?_familys.count:1;
}

- (NSInteger)collectionView:(UICollectionView *)collectionView numberOfItemsInSection:(NSInteger)section {
    if (_familys.count == 0) return 0.;
    
    AFamily *family = [_familys objectAtIndex:section];
    return family.homes.count>0?family.homes.count:0;
}

- (UICollectionViewCell *)collectionView:(UICollectionView *)collectionView
                  cellForItemAtIndexPath:(NSIndexPath *)indexPath {
    UICollectionViewCell *cell = [collectionView dequeueReusableCellWithReuseIdentifier:@"Cell" forIndexPath:indexPath];
    AFamily *family = [_familys objectAtIndex:indexPath.section];
    AHome *home = [family.homes objectAtIndex:indexPath.row];
    [((AFamilyCollectionView*)cell) setDataForCollectionCell:home];
    
    return cell;
}

- (void)collectionView:(UICollectionView *)collectionView didSelectItemAtIndexPath:(NSIndexPath *)indexPath {
    AFamilyCollectionView *familyhomeCell = (AFamilyCollectionView*)[_collectionView cellForItemAtIndexPath:indexPath];
    UIImageView *photoView = [familyhomeCell getPhotoView];
    CGRect oldPhotoFrame = photoView.frame;
    CGPoint point = [familyhomeCell convertPoint:photoView.frame.origin toView:self.view];
    
    CGRect startAnimationFrame = CGRectMake(point.x, point.y, photoView.frame.size.width, photoView.frame.size.height);
    [self.view addSubview:photoView];
    [photoView setFrame:startAnimationFrame];
    
    [UIView animateWithDuration:.5 animations:^{
        CGRect endAnimationFrame = CGRectMake(([UIScreen mainScreen].bounds.size.width-photoView.image.size.width)/2., ([UIScreen mainScreen].bounds.size.height - photoView.image.size.height)/2.-64, photoView.image.size.width, photoView.image.size.height);
        photoView.frame = endAnimationFrame;
        
        UINavigationController *selectedItem = (UINavigationController*)[[AMainRootController sharedInstance]getCurrentSelectedItem];
        ARootViewController *rootController = [selectedItem.viewControllers firstObject];
        [rootController updateLeftBtnStyle:YES];
        
        AFamily *family = [_familys objectAtIndex:indexPath.section];
        rootController.title = family.familyCategory;
        
        for (UICollectionViewCell *cell in [_collectionView visibleCells]) {
            cell.alpha =0.;
        }

        MZBookshelfCollectionViewLayout *layout = (MZBookshelfCollectionViewLayout*)_collectionView.collectionViewLayout;
        NSDictionary *bookShelfRectanges = [layout getBookShelfRectanges];
        [bookShelfRectanges enumerateKeysAndObjectsUsingBlock:^(id key, id shelfRect, BOOL *stop) {
            [layout layoutAttributesForElementsInRect:CGRectMake([shelfRect CGRectValue].origin.x, [shelfRect CGRectValue].origin.y-20, 0, 0)];
            // CGRectMake([shelfRect CGRectValue].origin.x, [shelfRect CGRectValue].origin.y-20, [UIScreen mainScreen].bounds.size.width, [shelfRect CGRectValue].size.height)
        }];
        
    } completion:^(BOOL finished) {
        AFamily *family = [_familys objectAtIndex:indexPath.section];
        NSUInteger selectedIndex = indexPath.row;
        AFamilyHomesController *familyHome = [[AFamilyHomesController alloc]initWithPushStyle:NO family:family selectedIndex:selectedIndex];
        UINavigationController *familyHomeNavi = [[UINavigationController alloc]initWithRootViewController:familyHome];
        UINavigationController *selectedItem = (UINavigationController*)[[AMainRootController sharedInstance]getCurrentSelectedItem];
        
        [selectedItem presentViewController:familyHomeNavi animated:NO completion:^{
            [photoView removeFromSuperview];
            photoView.frame = oldPhotoFrame;
            [familyhomeCell addSubview:photoView];
            
            ARootViewController *rootController = [selectedItem.viewControllers firstObject];
            [rootController updateLeftBtnStyle:NO];
            rootController.title = rootController.sideDrawer.menuTitle;
            
            for (UICollectionViewCell *cell in [_collectionView visibleCells]) {
                cell.alpha =1.;
            }
            MZBookshelfCollectionViewLayout *layout = (MZBookshelfCollectionViewLayout*)_collectionView.collectionViewLayout;
            [layout setItemSize:[[AUtilities sharedInstance]itemSizeBySpaceSize:20]];
            [_collectionView reloadData];
            
        }];
    }];
}

- (CGFloat)collectionView:(UICollectionView *)collectionView layout:(UICollectionViewLayout *)collectionViewLayout minimumInteritemSpacingForSectionAtIndex:(NSInteger)section {
    return 10.;
}


@end
