//
//  AMemberAttributeController.m
//  ahome
//
//  Created by andson-dile on 15/6/26.
//  Copyright (c) 2015å¹´ ushome. All rights reserved.
//

#import "AMemberAttributeController.h"
#import "UIImage+ImageEffects.h"
#import "AHomeLevelController.h"
#import "AHomeMergeCell.h"

@implementation AMemberAttributeController

static AMemberAttributeController *menuPanel;
+ (instancetype)shareInstance:(CGPoint)point member:(AMergeHomeMember *)member{
    if (menuPanel) {
        [AMemberAttributeController destroyInstance];
    }
    
    if (menuPanel == nil) {
        menuPanel = [[AMemberAttributeController alloc]init];
    }
    
    return menuPanel;
}

+ (void)destroyInstance {
    if (menuPanel) {
        [menuPanel offsetHidden];
    }
    
    menuPanel = nil;
}

- (void)viewDidLoad {
    [super viewDidLoad];
    [self.view setFrame:CGRectMake(0, 0, self.view.frame.size.width, self.view.frame.size.height)];
    
    AHomeLevelController *homeLevel = [AHomeLevelController sharedInstance];
    _imageView = [self newBlurrySegue:homeLevel.homePage];
    _imageView.alpha = 0.;
    [self.view addSubview:_imageView];
    
    UITableView *tableView = [[UITableView alloc]initWithFrame:CGRectMake(0, 0, self.view.frame.size.width, self.view.frame.size.height)];
    [tableView addGestureRecognizer:[[UITapGestureRecognizer alloc]initWithTarget:self action:@selector(doMemberClick)]];
    [tableView setBackgroundColor:[UIColor clearColor]];
    tableView.separatorStyle = UITableViewCellSeparatorStyleNone;
    tableView.userInteractionEnabled = YES;
    [_imageView addSubview:tableView];
    
    _baseAttriView = [[ABaseAttriPanelView alloc]initWithFrame:CGRectMake(10, (self.view.frame.size.height-200)/2., self.view.frame.size.width-20, 200)];
    _baseAttriView.layer.borderWidth = .5;
    _baseAttriView.layer.borderColor = [[UIColor whiteColor] CGColor];
    [tableView addSubview:_baseAttriView];
}

- (void)viewDidAppear:(BOOL)animated {
    [super viewDidAppear:animated];
    [self offsetShow];
}

- (UIImageView*)newBlurrySegue:(UIViewController*)source {
    CGSize windowSize = source.view.window.bounds.size;
    
    UIGraphicsBeginImageContextWithOptions(windowSize, YES, 2.0);
    CGContextRef context = UIGraphicsGetCurrentContext();
    [source.view.window.layer renderInContext:context];
    UIImage *snapshot = UIGraphicsGetImageFromCurrentImageContext();
    UIGraphicsEndImageContext();
    
    snapshot = [snapshot applyBlurWithRadius:@(15).doubleValue
                                   tintColor:[UIColor colorWithRed:0. green:0. blue:0. alpha:.2]
                       saturationDeltaFactor:@(1.f).doubleValue
                                   maskImage:nil];
    
    UIImageView *backgroundImageView = [[UIImageView alloc]initWithImage:snapshot];
    backgroundImageView.frame = CGRectMake(0, 0, windowSize.width, windowSize.height);
    backgroundImageView.userInteractionEnabled = YES;
    
    return backgroundImageView;
}

- (void)offsetShow {
    
    [UIView animateWithDuration:.5 animations:^{
        // animation for image face
        _imageView.alpha = 1.;
        
    } completion:^(BOOL finished) {
        
    }];
}

- (void)offsetHidden {
    
    [UIView animateWithDuration:.5 animations:^{
        _imageView.alpha = .0;
        
    } completion:^(BOOL finished) {
        [self.view removeFromSuperview];
    }];
}

- (void)touchesBegan:(NSSet *)touches withEvent:(UIEvent *)event {
    [AMemberAttributeController destroyInstance];
    
    AHomeLevelController *homeLevel = [AHomeLevelController sharedInstance];
    NSIndexPath *indexPath = [NSIndexPath indexPathForRow:0 inSection:0];
    AHomeMergeCell *homeCell = (AHomeMergeCell*)[homeLevel.homePage.tableView cellForRowAtIndexPath:indexPath];
    [homeCell startAnimation];
}

- (void)doMemberClick {
    [AMemberAttributeController destroyInstance];
    
    AHomeLevelController *homeLevel = [AHomeLevelController sharedInstance];
    NSIndexPath *indexPath = [NSIndexPath indexPathForRow:0 inSection:0];
    AHomeMergeCell *homeCell = (AHomeMergeCell*)[homeLevel.homePage.tableView cellForRowAtIndexPath:indexPath];
    [homeCell startAnimation];
}

@end
