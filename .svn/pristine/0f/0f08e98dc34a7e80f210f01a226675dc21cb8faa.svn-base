//
//  APagingPopupController.m
//  ahome
//
//  Created by andson-dile on 15/6/5.
//  Copyright (c) 2015年 ushome. All rights reserved.
//

#import "APagingPopupController.h"
#import "APagingAnnotation.h"

@implementation APagingPopupController

- (void)viewDidLoad {
    [super viewDidLoad];
    self.title = @"寻 呼";
}

- (void)viewDidAppear:(BOOL)animated {
    [super viewDidAppear:animated];
    
    _mapView = [[MAMapView alloc] initWithFrame:CGRectMake(0, 0, CGRectGetWidth(self.view.bounds), CGRectGetHeight(self.view.bounds))];
    _mapView.delegate = self;
    _mapView.showsUserLocation = YES;
    [self.view addSubview:_mapView];
    
    _geocoder=[[CLGeocoder alloc]init];
    
    _locationManager=[[CLLocationManager alloc]init];
    _locationManager.delegate=self;
    if (![CLLocationManager locationServicesEnabled] || [CLLocationManager authorizationStatus]==kCLAuthorizationStatusNotDetermined){
        [_locationManager requestWhenInUseAuthorization];
        
    }else if([CLLocationManager authorizationStatus]==kCLAuthorizationStatusAuthorizedWhenInUse){
        _locationManager.desiredAccuracy=kCLLocationAccuracyBest;
        _locationManager.distanceFilter=50.0;
        [_locationManager startUpdatingLocation];
    }
}

-(void)locationManager:(CLLocationManager *)manager didUpdateLocations:(NSArray *)locations{
    _location=[locations lastObject];
    CLLocationCoordinate2D coordinate=_location.coordinate;
    _mapView.centerCoordinate = coordinate;
    
    CLLocation *location=[[CLLocation alloc]initWithLatitude:coordinate.latitude longitude:coordinate.longitude];
    [_geocoder reverseGeocodeLocation:location completionHandler:^(NSArray *placemarks, NSError *error) {
        CLPlacemark *placemark=[placemarks lastObject];
        [self performSelectorOnMainThread:@selector(addAnnotation:) withObject:placemark waitUntilDone:YES];
    }];
    
    [_locationManager stopUpdatingLocation];
}

- (void)addAnnotation:(CLPlacemark*)mark {
    NSDictionary *markDic = mark.addressDictionary;
    NSString *city = [markDic objectForKey:@"City"];
    NSString *sublocality = [markDic objectForKey:@"SubLocality"];
    NSString *Street = [markDic objectForKey:@"Street"];
    NSString*title = [NSString stringWithFormat:@"%@-%@-%@",city,sublocality,Street];
    NSString *subTitle = [markDic objectForKey:@"Name"];

    
    NSLog(@"%@",title);
    NSLog(@"%@",subTitle);
}


@end
